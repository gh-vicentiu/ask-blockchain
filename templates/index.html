<!DOCTYPE html>
<html>
<head>
    <title>Chat Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div style="width: 100%; height: 50px; background-color: amber;"></div> <!-- Banner -->
    {% include 'menu.html' %}
    
    <!-- <div style="width: 500px; height: 300px; border: 1px solid black;"></div> Blank Box -->
    

    <div class="row">
        <div id="chat-container">
            <div id="message-display"></div>
            <div id="message-input-area">
                <input type="text" id="userIdInput" placeholder="{{user_id}}" />
                <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div id="paths-display">
            <!-- Paths Display Content Here -->
        </div>
    </div>    
    <script>
        let currentUserId = '{{user_id}}';
        let eventSource = null;
    
        document.addEventListener("DOMContentLoaded", () => {
            initializeEventSource();
            getUserPaths(currentUserId);
        });
    
        function initializeEventSource() {
            if (eventSource) {
                eventSource.close();
            }
    
            eventSource = new EventSource('/stream/' + currentUserId);
            eventSource.onmessage = (event) => {
                console.log("Received SSE message:", event.data);
                try {
                    const msgData = JSON.parse(event.data);
                    if (msgData.type === 'new_path') {
                        displayUserPaths([msgData.path_info], currentUserId, true);
                    } else if (msgData.hasOwnProperty('messaged_back')) {
                        addMessageToChat(msgData.user_id, msgData.messaged_back, true);
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                }
            };
        }
    
        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            const userId = document.getElementById("userIdInput").value || currentUserId;
    
            if (message.trim() !== '') {
                addMessageToChat(userId, message, false); // Add user's message to chat immediately
                fetch('/send_message', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, messaged_us: message })
                })
                .then(response => response.json())
                .then(() => {
                    messageInput.value = '';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        }
    
        document.getElementById("messageInput").addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                sendMessage();
            }
        });
    
        function addMessageToChat(userId, message, isSystemMessage) {
            const chatDiv = document.getElementById('message-display');
            const newMessage = document.createElement('div');
            newMessage.className = 'message';
            newMessage.textContent = isSystemMessage ? `System: ${message}` : `User ${userId}: ${message}`;
            chatDiv.appendChild(newMessage);
        }
    
        function getUserPaths(userId) {
            fetch('/get_user_paths/' + userId)
                .then(response => response.json())
                .then(paths => {
                    displayUserPaths(paths, userId);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    
        function displayUserPaths(paths, userId, append = false) {
            const pathsDiv = document.getElementById('paths-display');
            if (!append) {
                pathsDiv.innerHTML = '';
            }
            paths.forEach(path => {
                const newPath = document.createElement('div');
                newPath.id = `path-container-${path.id}`;
                newPath.innerHTML = `<a href="${path.url}" target="_blank">${path.name}</a>
                                    <p>(Description: ${path.description}, Exists: ${path.exists})</p>
                                    <button onclick="removePath('${userId}', '${path.id}')">Remove</button>`;
                pathsDiv.appendChild(newPath);
            });
        }
    
        function removePath(userId, pathId) {
            fetch(`/remove_user_paths/${userId}/${pathId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const pathElement = document.getElementById(`path-container-${pathId}`);
                        if (pathElement) {
                            pathElement.remove();
                        }
                    } else {
                        alert('Error removing path');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
    
       
    {% include 'footer.html' %}
</body>
</html>