<!DOCTYPE html>
<html>
<head>
    <title>Chat Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body.dark-mode {
            background-color: #333;
            color: #fff;
        }
        /* Other styles ... */

        /* Toggle Switch Styles */
        .switch {
            position: absolute; /* Positioning relative to the nearest positioned ancestor or the viewport */
            top: 10px;         /* 10 pixels from the top */
            left: 10px;        /* 10 pixels from the left */
            display: inline-block;
            width: 60px;
            height: 34px;
            background-color: #ccc;
            border-radius: 34px;
            transition: background-color 0.4s;
        }

        /* More styles... */
    </style>
</head>
</head>
<body>
    <div id="theme-toggle-container">
        <label class="switch">
            <input type="checkbox" id="themeToggleButton" onclick="toggleTheme()">
            <span class="slider round"></span> <!-- Removed onclick handler here -->
        </label>
    </div>
    <div id="chat-container">
        <div id="message-display"></div>
        <div id="message-input-area">
            <input type="text" id="userIdInput" placeholder="{{user_id}}" />
            <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        var currentUserId = '{{user_id}}';
        var eventSource = null;

        function sendMessage() {
            var message = document.getElementById("messageInput").value;
            var userId = document.getElementById("userIdInput").value || '{{user_id}}';

            fetch('/send_message', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: userId, message: message })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("messageInput").value = '';
                addMessageToChat(userId, message, false);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessageToChat(userId, message, isSystemMessage) {
            var chatDiv = document.getElementById('message-display');
            var newMessage = document.createElement('div');
            newMessage.classList.add('message');
            var displayText = isSystemMessage ? `System: ${message}` : `User ${userId}: ${message}`;
            newMessage.textContent = displayText;
            chatDiv.appendChild(newMessage);
        }

        function updateEventSource() {
            if (eventSource) {
                eventSource.close();
            }
            eventSource = new EventSource('/stream/' + currentUserId);

            eventSource.onmessage = function(event) {
                var msgData = JSON.parse(event.data);
                if (msgData.hasOwnProperty('message')) {
                    var messageText = msgData.message;
                    addMessageToChat(msgData.user_id, messageText, true);
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource failed:', error);
                eventSource.close();
            };
        }

        document.getElementById('userIdInput').addEventListener('change', function() {
            currentUserId = this.value || '{{user_id}}';
            updateEventSource();
        });

        function toggleTheme() {
            var bodyElement = document.body;
            bodyElement.classList.toggle('dark-mode');

            // Save the user's theme preference in localStorage
            if (bodyElement.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                document.getElementById('themeToggleButton').checked = true;
            } else {
                localStorage.setItem('theme', 'light');
                document.getElementById('themeToggleButton').checked = false;
            }
        }

        // Check for saved user preference, if any, and apply it
        document.addEventListener('DOMContentLoaded', (event) => {
            var themeToggleButton = document.getElementById('themeToggleButton');
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleButton.checked = true;
            } else {
                themeToggleButton.checked = false;
            }
        });

        updateEventSource();
    </script>
</body>
</html>
